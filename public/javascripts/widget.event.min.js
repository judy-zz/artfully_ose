var Config={base_uri:"http://localhost:3000/"},E;EventWidget=function(a,b){Config=$.extend(Config,b);$.getJSON(Event.uri(a),function(c){E=new Event(c);E.render($("#event"))})};
var Ticket={find:function(a,b){$.getJSON(Ticket.uri(a),function(c){b(c)})},uri:function(a){var b=Config.base_uri+"tickets.jsonp?callback=?";$.each(a,function(c,d){b+="&"+c+(c==="limit"?"=":"=eq")+d});return b}},ShoppingCart={$iframe:null,iframe:function(){if(this.$iframe===null)this.$iframe=$(document.createElement("iframe")).attr({name:"shopping-cart",id:"shopping-cart"}).appendTo("body");return this.$iframe},remove_iframe:function(){if(this.$iframe&&this.$iframe.remove())this.$iframe=null},buy:function(a){this.iframe().show();
this.hidden_form_for(a).submit().remove()},hidden_form_for:function(a){var b=$(document.createElement("form")).attr({method:"post",target:ShoppingCart.iframe().attr("name"),action:Config.base_uri+"orders.widget"});$(document.createElement("input")).attr({type:"hidden",name:"authenticity_token",value:Config.token}).appendTo(b);$.each(a,function(c,d){$(document.createElement("input")).attr({type:"hidden",name:"tickets[]",value:d.id}).appendTo(b)});return b.appendTo($("body"))}};
function Event(a){this.load(a)}Event.uri=function(a){return Config.base_uri+"events/"+a+".jsonp?callback=?"};
Event.prototype={load:function(a){this.name=a.name;this.venue=a.venue;this.producer=a.producer;this.load_performances({},a.performances);this.load_charts({},a.charts)},render:function(a){a.data("event",this);a.append($(document.createElement("h1")).addClass("event-name").text(this.name)).append($(document.createElement("h2")).addClass("event-venue").text(this.venue)).append($(document.createElement("h3")).addClass("event-producer").text(this.producer));this.render_performances(a)},render_performances:function(a){$ul=
$(document.createElement("ul")).addClass("performances").appendTo(a);$.each(this.performances,function(b,c){c.render($ul)})},load_performances:function(a,b){var c=this;this.performances=a;$.each(b,function(d,e){c.performances[e.id]=new Performance(e)})},load_charts:function(a,b){var c=this;this.charts=a;$.each(b,function(d,e){c.charts[e.id]=new Chart(e)})}};function Chart(a){this.load(a)}Chart.fetch=function(a){var b;$.getJSON(Chart.uri(a),function(c){b=new Chart(c)});return b};
Chart.prototype={load:function(a){this.id=a.id;this.name=a.name;this.load_sections([],a.sections)},load_sections:function(a,b){this.sections=a;if(b)for(var c=0;c<b.length;c++)this.sections.push(new Section(b[c]))},render:function(a){if(!this.$view)this.$view=this.view();this.$view.slideUp("slow",function(){$(this).hide().appendTo(a);$(this).slideDown("slow")})},view:function(){for(var a=$(document.createElement("ul")).addClass("sections"),b=0;b<this.sections.length;b++)this.sections[b].render(a);
return a}};function Section(a){this.load(a)}
Section.prototype={load:function(a){this.id=a.id;this.price=a.price;this.name=a.name;this.capacity=a.capacity},render:function(a){this.$target=$(document.createElement("li"));this.render_info(this.$target);this.render_form(this.$target);this.$target.appendTo(a)},render_info:function(a){$(document.createElement("span")).addClass("section-name").text(this.name).appendTo(a);$(document.createElement("span")).addClass("section-price").text("$"+this.price).appendTo(a)},render_form:function(a){var b=$(document.createElement("form")).appendTo(a),
c=this;a=$(document.createElement("select")).attr({name:"ticket_count",id:"ticket-count"}).appendTo(b);$(document.createElement("option")).text("1 Ticket").attr("value",1).appendTo(a);for(var d=2;d<=10;d++)$(document.createElement("option")).text(d+" Tickets").attr("value",d).appendTo(a);$(document.createElement("input")).attr("type","submit").val("Buy").appendTo(b);b.submit(function(){var e={limit:$("#ticket-count").val(),performance:$(this).parents(".performance").data("performance").raw_datetime,
price:c.price};Ticket.find(e,function(f){ShoppingCart.buy(f)});$(".sections").slideUp();return false})}};function Performance(a){this.load(a)}Performance.uri=function(a){return Config.base_uri+"performances/"+a+".jsonp?callback=?"};
Performance.prototype={render:function(a){this.$target=$(document.createElement("li")).addClass("performance").appendTo(a);this.$target.data("performance",this);$(document.createElement("span")).addClass("performance-datetime").text(this.datestring(this.datetime)).appendTo(this.$target);$(document.createElement("a")).addClass("ticket-search").text("Buy Tickets").attr("href","#").click({performance:this},function(b){E.charts[b.data.performance.chart_id].render(b.data.performance.$target);return false}).appendTo(this.$target);
return Boolean(this.$target)},load:function(a){this.raw_datetime=a.datetime;this.datetime=new Date(a.datetime);this.chart_id=a.chart_id;this.id=a.id},datestring:function(a){return a.toLocaleDateString()+" "+a.toLocaleTimeString()}};